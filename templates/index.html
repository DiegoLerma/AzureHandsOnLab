<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Azure OpenAI WebSocket Client con Síntesis de Voz</title>
    <style>
        /* Estilos para mejorar la interfaz de usuario */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            color: #333;
        }

        textarea {
            width: 100%;
            max-width: 600px;
            font-size: 16px;
            padding: 10px;
            margin-bottom: 10px;
        }

        button {
            font-size: 16px;
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 5px;
        }

        #responses {
            margin-top: 20px;
            max-width: 600px;
        }

        .response {
            margin-bottom: 15px;
            white-space: pre-wrap; /* Permite respetar saltos de línea */
        }

        .user-message {
            color: #0066cc;
            font-weight: bold;
        }

        .assistant-message {
            color: #333;
        }

        .error-message {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Cliente Azure OpenAI con Síntesis de Voz</h1>
    <textarea id="messageText" rows="4" placeholder="Escribe tu mensaje aquí..."></textarea><br>
    <button onclick="sendMessage()">Enviar</button>
    <button onclick="pauseAudio()">Pausar</button>
    <button onclick="stopAudio()">Detener</button>
    <h2>Respuestas:</h2>
    <div id="responses"></div>

    <script>
        const ws = new WebSocket("ws://127.0.0.1:8000/ws");
        const responsesDiv = document.getElementById('responses');
        const audioQueue = [];
        let isPlayingAudio = false;
        let currentAudioElement = null;

        ws.onopen = function() {
            console.log("Conexión WebSocket establecida.");
        };

        ws.onmessage = function(event) {
            const message = event.data;

            if (message.startsWith("__AUDIO__:")) {
                // Manejar mensaje de audio
                const audioBase64 = message.replace("__AUDIO__:", "");
                const audioBytes = atob(audioBase64);
                const arrayBuffer = new Uint8Array(audioBytes.length);
                for (let i = 0; i < audioBytes.length; i++) {
                    arrayBuffer[i] = audioBytes.charCodeAt(i);
                }
                const blob = new Blob([arrayBuffer], { type: 'audio/wav' }); // Ajusta el tipo MIME si es necesario
                const url = URL.createObjectURL(blob);

                // Añadir el audio a la cola
                audioQueue.push(url);

                // Intentar reproducir el siguiente audio si no hay otro reproduciéndose
                if (!isPlayingAudio) {
                    playNextAudio();
                }

            } else if (message.startsWith("__ERROR__:")) {
                // Manejar mensajes de error
                const errorMessage = message.replace("__ERROR__:", "");
                console.error("Error de síntesis de voz:", errorMessage);

                const errorDiv = document.createElement('div');
                errorDiv.className = 'response error-message';
                errorDiv.textContent = "Error: " + errorMessage;
                responsesDiv.appendChild(errorDiv);

            } else {
                // Manejar mensajes de texto
                updateAssistantMessage(message);
            }

            // Desplazar hacia abajo para ver el último mensaje
            responsesDiv.scrollTop = responsesDiv.scrollHeight;
        };

        ws.onerror = function(event) {
            console.error("WebSocket error:", event);
            alert("Ocurrió un error en la conexión WebSocket.");
        };

        ws.onclose = function() {
            console.warn("La conexión WebSocket se ha cerrado.");
            alert("La conexión con el servidor se ha cerrado.");
        };

        function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlayingAudio = false;
                return;
            }

            isPlayingAudio = true;
            const url = audioQueue.shift();
            currentAudioElement = new Audio(url);

            currentAudioElement.onended = function() {
                // Liberar el objeto URL creado
                URL.revokeObjectURL(url);
                currentAudioElement = null;
                // Reproducir el siguiente audio en la cola
                playNextAudio();
            };

            currentAudioElement.onerror = function(e) {
                console.error("Error al reproducir el audio:", e);
                // Intentar reproducir el siguiente audio
                currentAudioElement = null;
                playNextAudio();
            };

            currentAudioElement.play();
        }

        function pauseAudio() {
            if (currentAudioElement) {
                if (!currentAudioElement.paused) {
                    currentAudioElement.pause();
                    console.log("Audio pausado.");
                } else {
                    currentAudioElement.play();
                    console.log("Audio reanudado.");
                }
            }
        }

        function stopAudio() {
            if (currentAudioElement) {
                currentAudioElement.pause();
                currentAudioElement.currentTime = 0;
                currentAudioElement = null;
                isPlayingAudio = false;
                audioQueue.length = 0; // Limpiar la cola de audio
                console.log("Reproducción detenida y cola de audio vaciada.");
            }
        }

        function sendMessage() {
            const messageTextArea = document.getElementById('messageText');
            const messageText = messageTextArea.value.trim();

            if (messageText === "") {
                alert("Por favor, ingresa un mensaje antes de enviar.");
                return;
            }

            // Enviar mensaje al servidor
            ws.send(messageText);

            // Mostrar el mensaje del usuario en la interfaz
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'response user-message';
            userMessageDiv.textContent = "Tú: " + messageText;
            responsesDiv.appendChild(userMessageDiv);

            // Limpiar el campo de texto
            messageTextArea.value = "";

            // Reiniciar el acumulador del asistente para una nueva respuesta
            assistantMessageDiv = null;
            assistantMessageContent = "";
        }

        // Acumulador para el mensaje del asistente
        let assistantMessageDiv = null;
        let assistantMessageContent = "";

        function updateAssistantMessage(newText) {
            if (!assistantMessageDiv) {
                assistantMessageDiv = document.createElement('div');
                assistantMessageDiv.className = 'response assistant-message';
                assistantMessageDiv.style.whiteSpace = 'pre-wrap'; // Respetar saltos de línea
                responsesDiv.appendChild(assistantMessageDiv);
            }
            assistantMessageContent += newText;
            assistantMessageDiv.textContent = assistantMessageContent;
        }
    </script>
</body>
</html>
