<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storyteller de Historias de Terror</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-twinkle {
            animation: twinkle 2s infinite;
        }
        .pixelated {
            image-rendering: pixelated;
        }
        .pixel-button {
            font-family: 'VT323', monospace;
            image-rendering: pixelated;
            box-shadow: 0 4px 0 #000;
            transition: all 0.1s;
        }
        .pixel-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #000;
        }
        .neon-text {
            text-shadow: 0 0 3px #fff, 0 0 6px #fff, 0 0 9px #fff, 0 0 12px #fff;
        }
    </style>
</head>
<body class="bg-black min-h-screen flex flex-col items-center p-4 relative font-['VT323'] text-xl">
    <!-- Estrellas en movimiento -->
    <div id="stars" class="fixed inset-0"></div>

    <div class="w-full max-w-4xl z-10 flex flex-col items-center">
        <h1 class="text-9xl font-bold text-white text-center mt-12 mb-2 pixelated neon-text">Terror 404</h1>
        <div class="mb-6 relative">
            <div class="w-64 h-64 mx-auto">
                <img src="../images/fireplace.gif" alt="Fogata pixel art" class="pixelated w-full h-full">
            </div>
        <h2 class="text-2xl text-gray-400 text-center mb-4">By Diego Lerma</h2>
        </div>


        <div class="flex mb-6 w-full">
            <input type="text" id="messageInput" placeholder="Ingresa un tema para tu historia de terror..."
                   class="flex-grow mr-2 bg-gray-800 text-white border-gray-700 rounded p-2 pixelated text-xl">
            <button id="sendButton" class="pixel-button bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded text-2xl">
                Generar
            </button>
        </div>

        <div class="flex justify-center space-x-6 mb-6">
            <button id="playPauseButton" class="pixel-button bg-yellow-600 hover:bg-yellow-700 text-white font-bold p-2 rounded w-32 h-12 text-xl" disabled>
                Pausa
            </button>
            <button id="stopButton" class="pixel-button bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded w-32 h-12 text-xl" disabled>
                Detener
            </button>
        </div>
    </div>

    <div class="w-full max-w-6xl px-8 z-10">
        <p id="storyText" class="text-white font-bold text-2xl whitespace-pre-wrap"></p>
    </div>

    <script>
        // Generar estrellas
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 50; i++) {
            const star = document.createElement('div');
            star.className = 'absolute w-1 h-1 bg-white rounded-full animate-twinkle';
            star.style.top = `${Math.random() * 100}%`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.animationDuration = `${Math.random() * 3 + 2}s`;
            star.style.animationDelay = `${Math.random() * 2}s`;
            starsContainer.appendChild(star);
        }

        // Variables globales
        let ws;
        let audioQueue = [];
        let currentAudio = null;
        let isPlaying = false;

        // Elementos del DOM
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const playPauseButton = document.getElementById('playPauseButton');
        const stopButton = document.getElementById('stopButton');
        const storyText = document.getElementById('storyText');

        // Iniciar conexión WebSocket
        function connectWebSocket() {
            ws = new WebSocket("ws://127.0.0.1:8000/ws");

            ws.onopen = () => {
                console.log("Conexión WebSocket establecida");
                sendButton.disabled = false;
            };

            ws.onmessage = (event) => {
                const message = event.data;
                if (message.startsWith("__AUDIO__:")) {
                    handleAudioMessage(message);
                } else if (message.startsWith("__ERROR__:")) {
                    console.error("Error:", message.replace("__ERROR__:", ""));
                } else {
                    storyText.textContent += message;
                }
            };

            ws.onerror = (error) => {
                console.error("Error de WebSocket:", error);
            };

            ws.onclose = () => {
                console.log("Conexión WebSocket cerrada");
                sendButton.disabled = true;
            };
        }

        // Manejar mensajes de audio
        function handleAudioMessage(message) {
            const audioBase64 = message.replace("__AUDIO__:", "");
            const audioBytes = atob(audioBase64);
            const arrayBuffer = new Uint8Array(audioBytes.length);
            for (let i = 0; i < audioBytes.length; i++) {
                arrayBuffer[i] = audioBytes.charCodeAt(i);
            }
            const blob = new Blob([arrayBuffer], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            audioQueue.push(url);

            if (!isPlaying) {
                playNextAudio();
            }
        }

        // Reproducir siguiente audio en la cola
        function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                playPauseButton.disabled = true;
                stopButton.disabled = true;
                return;
            }

            isPlaying = true;
            playPauseButton.disabled = false;
            stopButton.disabled = false;
            playPauseButton.textContent = 'Pausar';
            const url = audioQueue.shift();
            currentAudio = new Audio(url);

            currentAudio.onended = () => {
                URL.revokeObjectURL(url);
                currentAudio = null;
                playNextAudio();
            };

            currentAudio.onerror = (e) => {
                console.error("Error al reproducir audio:", e);
                currentAudio = null;
                playNextAudio();
            };

            currentAudio.play();
        }

        // Enviar mensaje
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                messageInput.value = '';
                storyText.textContent = '';
            } else {
                console.error("WebSocket no está conectado");
            }
        }

        // Pausar/Reproducir audio
        function togglePlayPause() {
            if (currentAudio) {
                if (currentAudio.paused) {
                    currentAudio.play();
                    playPauseButton.textContent = 'Pausar';
                } else {
                    currentAudio.pause();
                    playPauseButton.textContent = 'Reproducir';
                }
            }
        }

        // Detener audio
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            audioQueue = [];
            isPlaying = false;
            playPauseButton.disabled = true;
            stopButton.disabled = true;
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        playPauseButton.addEventListener('click', togglePlayPause);
        stopButton.addEventListener('click', stopAudio);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // Iniciar conexión WebSocket al cargar la página
        connectWebSocket();
    </script>
</body>
</html>